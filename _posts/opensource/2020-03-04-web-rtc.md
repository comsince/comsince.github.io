---
layout: post
title: 实时音视频开发的工程化实践[正在编辑]
category: web-rtc
description: 
---

这里只是根据实时音视频开发，说明技术的路线，主要展示该技术得以工程应用需要的理论背景。该篇不是主要将实时音视频的所涉及的音视频相关的理论知识，由于实时音视频的相关的处理算法并不是本篇内容的关注重点，这里只是重点从工程角度说明`WebRTC`这项技术在简化实时音视频方面带来的帮助，然后围绕这项技术说明在服务端，客户端领域我们需要理解哪些工程化问题

> 基于平台的 API 做应用开发，并不是一个可以走得多远的方向，真正有价值的地方在于与具体的业务方向结合。这个是业务领域精通的指导思想，所有的技术都要找到相应的落地点

# 网络基础
  TCP/IP网络基础，IP路由，网络分层，以及数据如何自顶而下实现传输

# WebRTC实时音视频技术的整体架构介绍
  对webRTC整体技术有所了解，进而进一步了解我主要的学习重点，以及我们在开发实时聊天时需要解决的问题，可以参考这篇文章[WebRTC实时音视频技术的整体架构介绍](http://www.52im.net/thread-284-1-1.html)
  > WebRTC技术架构图

  ![image](http://www.52im.net/data/attachment/forum/201605/05/111321jf5oiev7fnznfnon.png)

# WebRTC服务器
  理解实时语音通信相关的通信策略，如何进行呼叫应答。也即是在建立媒体流之前如何进行对端链接，这需要信令服务器与turn服务器的配合

## WebRTC协议概述

### 理解p2p穿透技术

* [P2P技术之STUN、TURN、ICE详解](http://www.52im.net/thread-557-1-1.html)

### WebRTC协议
#### NAT
网络地址转换协议Network Address Translation (NAT) 用来给你的（私网）设备映射一个公网的IP地址的协议。一般情况下，路由器的WAN口有一个公网IP，所有连接这个路由器LAN口的设备会分配一个私有网段的IP地址（例如192.168.1.3）。私网设备的IP被映射成路由器的公网IP和唯一的端口，通过这种方式不需要为每一个私网设备分配不同的公网IP，但是依然能被外网设备发现。

一些路由器严格地限定了部分私网设备的对外连接。这种情况下，即使STUN服务器识别了该私网设备的公网IP和端口的映射，依然无法和这个私网设备建立连接。这种情况下就需要转向TURN协议。

#### STUN
NAT的会话穿越功能Session Traversal Utilities for NAT (STUN) (缩略语的最后一个字母是NAT的首字母)是一个允许位于NAT后的客户端找出自己的公网地址，判断出路由器阻止直连的限制方法的协议。

客户端通过给公网的STUN服务器发送请求获得自己的公网地址信息，以及是否能够被（穿过路由器）访问。

![image](/images/web-rtc/webrtc-stun.png)

#### TURN
一些路由器使用一种“对称型NAT”的NAT模型。这意味着路由器只接受和对端先前建立的连接（就是下一次请求建立新的连接映射）。

NAT的中继穿越方式Traversal Using Relays around NAT (TURN) 通过TURN服务器中继所有数据的方式来绕过“对称型NAT”。你需要在TURN服务器上创建一个连接，然后告诉所有对端设备发包到服务器上，TURN服务器再把包转发给你。很显然这种方式是开销很大的，所以只有在没得选择的情况下采用。

![image](/images/web-rtc/webrtc-turn.png)

#### ICE

交互式连接设施Interactive Connectivity Establishment (ICE) 是一个允许你的浏览器和对端浏览器建立连接的协议框架。在实际的网络当中，有很多原因能导致简单的从A端到B端直连不能如愿完成。这需要绕过阻止建立连接的防火墙，给你的设备分配一个唯一可见的地址（通常情况下我们的大部分设备没有一个固定的公网地址），如果路由器不允许主机直连，还得通过一台服务器转发数据。ICE使用以上技术实现

## 信令与视频通话
描述信令服务器在实现点对点视频通话的作用，说明如何协商并建立通话链接，详情参考[信令与视频通话](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling)
> 这篇文章介绍ice协议框架与与信令服务在通信中扮演的角色[WebRTC 入门教程（二）WebRTC信令控制与STUN/TURN服务器搭建](https://rtcdeveloper.com/t/topic/13742)

信令服务器在其中扮演中重要角色，因此良好的实时通讯信令设计，决定一个实时音视频通讯的关键，需要信令服务器帮助通信两端建立链接，下图为链接的流程图

![image](https://web-cdn.agora.io/optimized/2X/e/e908e7661a41b53a874a3ec68c78246fef5f4d56_2_575x500.png)

## 信令交换流程
> 所有的程序逻辑都围绕这个信令交换流程进行代码编写，因此理解信令交换流程至关重要，前面已经对信令服务器,Stun,turn服务器做过简单介绍，现在主要说明它们之间是如何进行协同工作的

### 信令事务流程
![image](/images/web-rtc/WebRTC - Signaling Diagram.svg)
### ICE 候选交换过程
![image](/images/web-rtc/WebRTC - ICE Candidate Exchange.svg)

**NOTE:** 详情请参考：[信令与视频通话](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling)
## 实践

### 熟悉WebRTC相关API
* [WebRTC API](https://javascript.ruanyifeng.com/htmlapi/webrtc.html#toc1)

> 学习相关平台的API，如何采集本地音视频资源显示，如何进行候选通知，详情参考[webrtc-samples](https://github.com/webrtc/samples)

### 定义通话信令格式

#### 消息交互流程

* 发送者发送`CallStartMessage`给接收者，并启动启动video track进行视频预览
* 接收者接收`CallStartMessage`,开启会话，等待用户确定是否接收音视频请求
* 接收者如果同意接听，则发送`AnswerTMessage`，`AnswerMessage`，之后创建peerconnection，接收回调sdp成功回调，发送offer信息，载体为`SignalMessage`
* 发送接收到`offer`消息，设置remoteDescription之后，创建`answer`消息，发送给对端
* 接收端收到`answer`消息，设置remoteDescription

# 参考资料

* [新手入门：到底什么是WebRTC服务器，以及它是如何联接通话的？](http://www.52im.net/thread-356-1-1.html)
* [WebRTC实时音视频技术基础：基本架构和协议栈](http://www.52im.net/thread-442-1-1.html)
* [WebRTC　简介](https://mp.weixin.qq.com/s/NsiU8rVYYMbDjVBGZlr3Xg)